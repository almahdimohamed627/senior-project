def build() {
    echo "ðŸ—ï¸ Starting build for core-backend component"
    
    stage('Validate Docker Compose') {
        sh '''
            echo "Validating docker-compose.yml..."
            docker compose config
        '''
    }
    
    stage('Clean Previous Builds') {
        sh '''
            echo "Cleaning up previous builds and images..."
            docker rmi --force core-backend-nest-app
            # Stop and remove any existing containers from previous builds
            docker compose down --remove-orphans --rmi all 2>/dev/null || true
            
            # Remove any dangling images that might interfere with new build
            docker image prune -f 2>/dev/null || true
            
            # ðŸ”¥ CRITICAL FIX: Specific cleanup for nest-app images to ensure fresh build
            docker rmi -f $(docker images | grep "nest-app" | awk "{print \$3}") 2>/dev/null || true
        '''
    }
    
    stage('Pull Images') {
        sh '''
            echo "Pulling Docker images from Docker Hub..."
            docker compose pull --ignore-pull-failures
        '''
    }
    
    stage('Build Services') {
        // Check if we should build
        def shouldBuild = fileExists('Dockerfile') || 
                         sh(script: 'docker compose config | grep -q "build:"', returnStatus: true) == 0
        
        if (shouldBuild) {
            sh '''
                echo "Building core-backend services..."
                # Build the specific service image directly, ensuring no-cache
                docker build --no-cache --pull -t core-backend-nest-app .

                # Even with direct build, try a final compose build to ensure service configuration is updated
                docker compose build --no-cache nest-app || echo "Compose build may be redundant but attempted."
            '''
        } else {
            echo "âš ï¸ No build configuration found - skipping build"
        }
    }
    
    stage('Smoke Test') {
        try {
            sh '''
                echo "Starting services for smoke test..."
                docker compose up -d
                
                # Wait for services to be ready
                sleep 30
                
                # Check if services are running
                docker compose ps
                
                # Run basic health checks (adjust based on your services)
                if docker compose ps | grep -q "Up"; then
                    echo "âœ… Services are running"
                else
                    echo "âŒ Some services failed to start"
                    exit 1
                fi
            '''
        } catch (Exception e) {
            echo "âŒ Smoke test failed: ${e.message}"
            throw e
        } finally {
            sh '''
                echo "Stopping services after smoke test..."
                docker compose down
            '''
        }
    }
    
    stage('Save Compose Configuration') {
        sh '''
            # Generate the final compose config for deployment
            docker compose config > docker-compose.resolved.yml
        '''
        archiveArtifacts artifacts: 'docker-compose.resolved.yml', fingerprint: true
    }
    
    echo "âœ… core-backend build completed successfully"
}

def deploy() {
    echo "ðŸš€ Starting deployment for core-backend component"
    
    try {
        withCredentials([file(credentialsId: "core-backend.env", variable: 'ENV_FILE')]) {
            sh """
                cp "\$ENV_FILE" .env
                chmod 600 .env
                docker compose config
                docker compose down --remove-orphans 2>/dev/null || true
                docker compose pull --ignore-pull-failures 2>/dev/null || true
                docker compose --env-file .env up -d
                sleep 60
            """
        }

        sh """
            docker compose ps || true
            docker ps --filter "name=core-backend" --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}" || true
        """

        // Custom health check for core-backend
        sh '''
            for i in 1 2 3; do
                if curl -s -f http://localhost:3000/health >/dev/null 2>&1 || 
                   curl -s -f http://localhost:3000 >/dev/null 2>&1; then
                    echo "âœ… core-backend is accessible at http://localhost:3000"
                    break
                else
                    echo "â³ Attempt $i: core-backend not yet accessible, waiting..."
                    sleep 30
                fi
            done
            if ! curl -s -f http://localhost:3000/health >/dev/null 2>&1 && 
               ! curl -s -f http://localhost:3000 >/dev/null 2>&1; then
                echo "âš ï¸ core-backend not accessible, showing recent logs..."
                docker compose logs --tail=50 nest-app || true
            fi
        '''

        echo "âœ… core-backend deployment completed successfully"
    } catch (Exception e) {
        echo "âŒ Deployment failed for core-backend: ${e.message}"
        sh """
            echo "=== Debug Information ==="
            docker compose ps 2>/dev/null || true
            echo "=== Recent Logs ==="
            docker compose logs --tail=100 2>/dev/null || true
        """
        sh "rm -f .env 2>/dev/null || true"
        throw e
    }
}

// Optional: Add other utility methods
def test() {
    echo "ðŸ§ª Running tests for core-backend"
    // Add your test logic here
}

def cleanup() {
    echo "ðŸ§¹ Cleaning up core-backend resources"
    sh '''
        docker compose down --remove-orphans --rmi all 2>/dev/null || true
        docker rmi -f core-backend-nest-app 2>/dev/null || true
    '''
}

// Return this library
return this