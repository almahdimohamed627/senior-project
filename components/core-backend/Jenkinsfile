
    pipeline {
        agent any
        
        environment {
            COMPONENT_NAME = 'core-backend'  // Update with actual name
            COMPOSE_PROJECT_NAME = "${env.JOB_NAME}-${env.BUILD_NUMBER}"
        }
        
        stages {
            stage('Validate Docker Compose') {
                steps {
                    script {
                        sh '''
                            echo "Validating docker-compose.yml..."
                            docker-compose config
                        '''
                    }
                }
            }
            
            stage('Clean Previous Builds') {
                steps {
                    script {
                        sh '''
                            echo "Cleaning up previous builds and images..."
                            docker rmi --force core-backend-nest-app
                            # Stop and remove any existing containers from previous builds
                            docker-compose down --remove-orphans --rmi all 2>/dev/null || true
                            
                            # Remove any dangling images that might interfere with new build
                            docker image prune -f 2>/dev/null || true
                            
                            # üî• CRITICAL FIX: Specific cleanup for nest-app images to ensure fresh build
                            docker rmi -f $(docker images | grep "nest-app" | awk "{print \$3}") 2>/dev/null || true
                        '''
                    }
                }
            }
            stage('Pull Images') {
                steps {
                    script {
                        sh '''
                            echo "Pulling Docker images from Docker Hub..."
                            docker-compose pull --ignore-pull-failures
                        '''
                    }
                }
            }
            
            stage('Build Services') {
                when {
                    expression {
                        fileExists('Dockerfile') ||
                        sh(script: 'docker-compose config | grep -q "build:"', returnStatus: true) == 0
                    }
                }
                steps {
                    sh '''
                        # Build the specific service image directly, ensuring no-cache
                        docker build --no-cache --pull -t core-backend-nest-app ./components/core-backend

                        # Even with direct build, try a final compose build to ensure service configuration is updated
                        docker-compose build --no-cache nest-app || echo "Compose build may be redundant but attempted."
                    '''
                }
            }
            
            stage('Smoke Test') {
                steps {
                    script {
                        sh '''
                            echo "Starting services for smoke test..."
                            docker-compose up -d
                            
                            # Wait for services to be ready
                            sleep 30
                            
                            # Check if services are running
                            docker-compose ps
                            
                            # Run basic health checks (adjust based on your services)
                            if docker-compose ps | grep -q "Up"; then
                                echo "‚úÖ Services are running"
                            else
                                echo "‚ùå Some services failed to start"
                                exit 1
                            fi
                        '''
                    }
                }
                post {
                    always {
                        sh '''
                            echo "Stopping services after smoke test..."
                            docker-compose down
                        '''
                    }
                }
            }
            
            stage('Save Compose Configuration') {
                steps {
                    sh '''
                        # Generate the final compose config for deployment
                        docker-compose config > docker-compose.resolved.yml
                    '''
                    archiveArtifacts artifacts: 'docker-compose.resolved.yml', fingerprint: true
                }
            }
        }
        
        post {
            always {
                script {
                    // Clean up any orphaned containers
                    sh '''
                        docker-compose down --remove-orphans 2>/dev/null || true
                    '''
                }
            }
            success {
                echo "‚úÖ ${env.COMPONENT_NAME} Docker Compose deployment prepared successfully"
            }
            failure {
                echo "‚ùå ${env.COMPONENT_NAME} Docker Compose deployment failed"
            }
        }
    }
