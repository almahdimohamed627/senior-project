<div class="container">

    <!--  Toolbar -->
    @if (showToolbar()) {
    <div class="mb-4 rounded-2xl border border-slate-200 bg-white shadow-sm p-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">

            <!-- Search -->
            @if (searchConfig()) {
            <div class="w-full lg:max-w-md">
                <div class="relative">
                    <i class="pi pi-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input pInputText [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)"
                        [placeholder]="searchConfig()?.placeholder || 'Search...'"
                        class="w-full !pl-11 !pr-4 !py-3 !rounded-xl !border-slate-200 focus:!border-indigo-400 focus:!ring-2 focus:!ring-indigo-100 !text-slate-700" />
                </div>
            </div>
            }

            <!-- Filters -->
            <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                @for (filter of filtersConfig(); track filter.field) {
                <div class="min-w-[220px]">
                    <p-dropdown [options]="getFilterOptions(filter)" [ngModel]="getFilterValue(filter.field)"
                        (ngModelChange)="setFilterValue(filter.field, $event)"
                        [placeholder]="filter.placeholder || ('Filter ' + filter.label)" [showClear]="true"
                        appendTo="body" styleClass="w-full !rounded-xl !border-slate-200"
                        panelStyleClass="!rounded-xl"></p-dropdown>
                </div>
                }

                @if (searchTerm() || activeFilterCount() > 0) {
                <button pButton type="button" icon="pi pi-times" label="Clear"
                    class="!rounded-xl !px-4 !py-3 !border !border-slate-200 !bg-white !text-slate-700 hover:!bg-slate-50"
                    (click)="clearAll()"></button>
                }
            </div>
        </div>

        <div class="mt-3 flex flex-wrap items-center gap-2 text-sm text-slate-500">
            <span class="font-medium text-slate-700">{{ totalRecords() }}</span>
            <span>results</span>

            @if (activeFilterCount() > 0) {
            <span class="ml-2 inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-slate-700">
                <i class="pi pi-filter text-xs"></i>
                <span class="text-xs font-semibold">{{ activeFilterCount() }}</span>
                <span class="text-xs">filters active</span>
            </span>
            }
        </div>
    </div>
    }

    <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden relative" [ngClass]="{ 'min-h-screen': loading() }">

        @if (loading()) {
        <div class="absolute inset-0 z-20 flex items-center justify-center bg-white/70 backdrop-blur-sm">
            <div class="flex flex-col items-center gap-3">
                <video class="w-96 object-contain animate-bounce" type="video/mp4" src="/loader.mp4" autoplay muted loop playsinline></video>
                <p class="text-slate-600 font-medium text-sm">Loading...</p>
            </div>
        </div>
        }

        <p-table [value]="loading() ? [] : paginatedData()" showGridlines="true" stripedRows="true"
            responsiveLayout="scroll" styleClass="p-datatable-sm p-datatable-striped !w-full" [rows]="rows()"
            [first]="first()" [totalRecords]="totalRecords()">

            <!-- Header -->
            <ng-template pTemplate="header">
                <tr class="!bg-gradient-to-r !from-slate-50 !to-white">
                    @for (column of columns(); track column.field) {
                    <th
                        [ngClass]="column.headerClass || '!text-slate-700 !font-semibold !text-sm !py-2 !px-4 !border-b !border-slate-200'">
                        <div class="flex items-center gap-2">
                            <span class="tracking-wide">{{ column.header }}</span>
                            <span class="h-1 w-1 rounded-full bg-slate-300"></span>
                        </div>
                    </th>
                    }

                    @if (actions().length > 0) {
                    <th
                        class="!text-slate-700 !font-semibold !text-sm !py-3 !px-4 !border-b !border-slate-200 !text-center !w-40">
                        Actions
                    </th>
                    }
                </tr>
            </ng-template>

            <!-- Body -->
            <ng-template pTemplate="body" let-row>
                <tr class="group hover:!bg-slate-50 !transition-colors !duration-150">
                    @for (column of columns(); track column.field) {
                    <td class="!py-2 !px-4 !border-b !border-slate-100" [ngClass]="resolveCellClass(column, row)">
                        <!-- IMAGE -->
                        @if (column.type === 'image') {
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <img [src]="getImageUrl(row, column)"
                                    [alt]="getFieldValue(row, column.field) || row['name'] || 'Image'"
                                    class="w-20 h-20 object-contain rounded-xl border border-slate-200 bg-slate-50 p-1 shadow-sm"
                                    onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%23f1f5f9\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%2394a3b8\' font-size=\'20\'%3E?%3C/text%3E%3C/svg%3E'" />
                                <span
                                    class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full bg-emerald-400 ring-2 ring-white"></span>
                            </div>
                        </div>
                        }

                        <!-- CHIP -->
                        @else if (column.type === 'chip') {
                        <p-chip [label]="getFieldValue(row, column.field) || '-'"
                            [styleClass]="'!text-xs !font-semibold !rounded-full !px-3 !py-1 ' + resolveChipStyle(getFieldValue(row, column.field))"></p-chip>
                        }

                        <!-- PHONE -->
                        @else if (column.type === 'phone') {
                        <div class="flex items-center gap-2 text-slate-700">
                            <i class="pi pi-phone text-slate-400"></i>
                            <span class="font-medium">
                                {{ formatPhoneNumber(getFieldValue(row, column.field)) }}
                            </span>
                        </div>
                        }

                        <!-- TEXT -->
                        @else {
                        <div class="flex items-center">
                            <span class="text-slate-700 font-medium truncate max-w-[280px]">
                                {{ getFieldValue(row, column.field) }}
                            </span>
                        </div>
                        }
                    </td>
                    }

                    <!-- Actions -->
                    @if (actions().length > 0) {
                    <td class="!py-4 !px-6 !text-center !border-b !border-slate-100">
                        <div class="flex items-center justify-center gap-2">
                            @for (action of getActions(row); track action.label || action.toggleField) {

                            <!-- TOGGLE -->
                            @if (action.type === 'toggle') {
                            <div
                                class="flex items-center justify-center rounded-xl bg-slate-50 px-2 py-1 border border-slate-200">
                                <p-toggleswitch [(ngModel)]="row[action.toggleField!]" styleClass="!mt-[8px]"
                                    (onChange)="action.onToggle?.($event.checked, row)" />
                            </div>
                            }

                            <!-- BUTTON -->
                            @else {
                            <p-button 
                                [label]="action.label" 
                                [icon]="action.icon" 
                                size="small" 
                                [severity]="action.severity"
                                [disabled]="resolveActionDisabled(action, row)"
                                [loading]="resolveActionLoading(action, row)"
                                (onClick)="handleAction(action, row)" 
                                styleClass="!text-xs !rounded-xl !text-center !px-3 !py-2" />
                                }
                            }
                        </div>
                    </td>
                    }
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                @if (!loading()) {
                <tr>
                    <td [attr.colspan]="columns().length + (actions().length > 0 ? 1 : 0)" class="!text-center !py-12">
                        <div class="flex flex-col items-center justify-center gap-3">
                            <div class="w-16 h-16 rounded-2xl bg-slate-100 flex items-center justify-center">
                                <i class="pi pi-inbox text-3xl text-slate-400"></i>
                            </div>
                            <p class="text-slate-600 font-semibold text-sm">{{ emptyMessage() }}</p>
                            <p class="text-slate-400 text-xs">Try adjusting search or filters.</p>
                        </div>
                    </td>
                </tr>
                }
            </ng-template>

        </p-table>

        <!-- âœ… Paginator (Hide while loading) -->
        @if (!loading() && totalRecords() > rows()) {
        <div class="border-t border-slate-200 bg-white">
            <p-paginator [rows]="rows()" [totalRecords]="totalRecords()" [first]="first()"
                (onPageChange)="onPageChange($event)" [rowsPerPageOptions]="rowsPerPageOptions()"
                styleClass="!border-none !bg-white !rounded-b-2xl !py-3"></p-paginator>
        </div>
        }
    </div>

</div>